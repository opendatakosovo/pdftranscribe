<style type="text/css">
    #the-canvas {
        cursor: move;
    }
  	.control-label{
      font-weight: bold;
    }
</style>

<div class="row">
    <!-- Success and Error Messages for the user --> 
    <div class="span6 offset2" style="height:50px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong>Well done! Your answer has been saved</strong>
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none;">
            <strong>The task has been completed! Thanks a lot!</strong>
        </div>
        <div id="loading" class="alert alert-info">
            <strong>Loading the PDF file...</strong>
        </div>
        <div id="finish" class="alert alert-success" style="display:none;">
            <strong>Congratulations! You have participated in all available tasks!</strong>
            <br/>
            <div class="alert-actions">
                <a class="btn small" href="/">Go back</a>
                <a class="btn small" href="/project">or, Check other projects</a>
            </div>
        </div>
        <div id="error" class="alert alert-error" style="display:none;">
            <a class="close">×</a>
            <strong>Error! Something went wrong, please contact the site administrators</strong>
        </div>
    </div>
</div> <!-- End Success and Error Messages for the user -->

<div class="row skeleton">
    <div id="question" class="span12">
      <h1>Question</h1>
      <span class="label label-info"><i class="icon icon-bullhorn"></i> Important</span> <strong>This is just a demo project. You can re-use the code to create your own project.</strong>
      <hr>
    </div>
</div>

<div class="row skeleton">
    <!-- Answer buttons -->
    <div id="answer" class="span8" style="text-align:center;">
        <div class="btn-group" style="padding-bottom:5px;">
            <button id="prev" class="btn btn-navigate disabled" value="prev"><i class="icon-arrow-left"></i></button>
            <button class="btn btn-zoom" value=0>1:1</button>
            <button class="btn btn-zoom" value=1><i class="icon icon-white icon-zoom-in"></i></button>
            <button class="btn btn-zoom" value=-1><i class="icon icon-white icon-zoom-out"></i></button>
            <button id="next" class="btn btn-navigate" value="next"><i class="icon-arrow-right"></i></button>
        </div>
        <div id="pages" style="margin-top:2%;">
          <p>Page <span id="currentPage">#</span> of <span id="totalPages">#</span></p>
        </div>
     </div>
    <div class="span4">
        <p>You are working now on task: <span id="task-id" class="label label-warning">#</span></p>
        <p>You have completed: <span id="done" class="label label-info"></span> tasks from
        <span id="total" class="label label-inverse"></span></p>
        <div class="progress progress-striped">
            <div id="progress" rel="tooltip" title="#" class="bar" style="width: 0%;"></div>
        </div>
        <div>
            <!--h5>Write here the transcription</h5--!>
            <!--form class="form-inline">
                <textarea id="text" rows="10" style="width:100%;"></textarea>
            </form-->
          
          	<form class="form" role="form">
            	<div class="form-group">
                	<div class="col-sm-12">
                		<div class="dropdown">
                          <button class="btn btn-default dropdown-toggle" type="button" id="dropdown-category" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                            <span class="value">Category</span>
                            <span class="caret"></span>
                          </button>
                          <br><br>
                          <ul id="dropdown-menu-category" class="dropdown-menu" aria-labelledby="dropdownMenu1">
                            <li><a>Death Penalty</a></li>
                            <li><a>Human Rights Defender</a></li>
                            <li><a>Prisoners of Conscience</a></li>
                            <li><a>Refugees and Migrants</a></li>
                            <li><a>Stop Action</a></li>
                          </ul>
                        </div>
                	</div>
            	</div>
              	<div class="form-group">
                	<label class="control-label col-sm-2" for="perpetrator">Perpetrator:</label>
                	<div class="col-sm-10"> 
                  		<input type="text" class="form-control" id="perpetrator">
                	</div>
              	</div>
              	<div class="form-group">
                	<label class="control-label col-sm-2" for="victim">Victim:</label>
                	<div class="col-sm-10"> 
                  		<input type="text" class="form-control" id="victim">
                	</div>
              	</div>
              	<div class="form-group">
                	<label class="control-label col-sm-2" for="reason">Reason:</label>
                	<div class="col-sm-10"> 
                  		<input type="text" class="form-control" id="reason">
                	</div>
              	</div>
              	
              	<!-- Refugees and Migrants -->
             	<div class="ram-form-groups" style="display:none">
                  <div class="form-group">
                    <label class="control-label col-sm-2">Type:</label>
                    <div class="col-sm-10">
                      <div class="radio">
                        <label><input type="radio" name="mar-type">Economic Migrant</label>
                      </div>
                      <div class="radio">
                        <label><input type="radio" name="mar-type">Refugee</label>
                      </div>
                    </div>
                  </div>
              	</div>
              
              	<!-- Human Rights Defenders -->
             	<div class="hrd-form-groups" style="display:none">
                  <div class="form-group">
                    <label class="control-label col-sm-2">Context:</label>
                    <div class="col-sm-10">
                      <div class="checkbox">
                        <label><input type="checkbox" value="Prosecuted on fabricated charges">Prosecuted on fabricated charges.</label>
                      </div>
                      <div class="checkbox">
                        <label><input type="checkbox" value="Crime not recognized under international law.">Crime not recognized under international law.</label>
                      </div>
                    </div>
                  </div>
                </div>
              
              	<!-- Prisoners of Conscience -->
             	<div class="poc-form-groups" style="display:none">
                  <div class="form-group">
                    <label class="control-label col-sm-2" for="imprisoned-since">Imprisoned Since:</label>
                    <div class="col-sm-10"> 
                      <input type="text" class="form-control" id="imprisoned-since" placeholder="dd/mm/yyyy">
                	</div>
                  </div>
                  <div class="form-group">
                    <label class="control-label col-sm-2">Context:</label>
                    <div class="col-sm-10">
                      <div class="checkbox">
                        <label><input type="checkbox" value="Prosecuted on fabricated charges">Prosecuted on fabricated charges.</label>
                      </div>
                      <div class="checkbox">
                        <label><input type="checkbox" value="Crime not recognized under international law.">Crime not recognized under international law.</label>
                      </div>
                    </div>
                  </div>
                </div>
              
              	<!-- Death Penalty -->
              <div class="dp-form-groups" style="display:none">
                  <div class="form-group">
                    <label class="control-label col-sm-2">Context:</label>
                    <div class="col-sm-10">
                      <div class="checkbox">
                        <label><input type="checkbox" value="Related to terror">Related to terror.</label>
                      </div>
                      <div class="checkbox">
                        <label><input type="checkbox" value="Forced confession">Forced confession.</label>
                      </div>
                    </div>
                  </div>
                </div>
          	</form>
            <button class="btn btn-submit">Submit</button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/ui/1.9.1/jquery-ui.js"></script>
<script src="/static/js/pdf/scrollsync.js"></script>
<script src="/static/js/pdf/dragscrollable.js"></script>
<script src="/static/js/pdf/pdf.js" type="text/javascript" ></script>

<script type="text/javascript">
(function() {
  
  
  
$("#dropdown-menu-category li a").click(function(){
  var category = $(this).text();
  $("#dropdown-category .value").text(category);
  $("#dropdown-category .value").val(category);
  

  if(category === "Human Rights Defender"){
    $(".ram-form-groups").css('display', 'none');
    $(".hrd-form-groups").css('display', 'block');
    $(".poc-form-groups").css('display', 'none');
    $(".dp-form-groups").css('display', 'none');
    
  }else if(category === "Prisoners of Conscience"){
    $(".ram-form-groups").css('display', 'none');
    $(".hrd-form-groups").css('display', 'none');
    $(".poc-form-groups").css('display', 'block');
    $(".dp-form-groups").css('display', 'none');
    
  }else if(category === "Refugees and Migrants"){
    $(".ram-form-groups").css('display', 'block');
    $(".hrd-form-groups").css('display', 'none');
    $(".poc-form-groups").css('display', 'none');
    $(".dp-form-groups").css('display', 'none');
    
  }else if(category === "Death Penalty"){
    $(".ram-form-groups").css('display', 'none');
    $(".hrd-form-groups").css('display', 'none');
    $(".poc-form-groups").css('display', 'none');
    $(".dp-form-groups").css('display', 'block');
    
  }else{
    $(".ram-form-groups").css('display', 'none');
  	$(".hrd-form-groups").css('display', 'none');
    $(".poc-form-groups").css('display', 'none');
    $(".dp-form-groups").css('display', 'none');
  }
});
  
//
// Disable workers to avoid yet another cross-origin issue (workers need the URL of
// the script to be loaded, and currently do not allow cross-origin scripts)
//
PDFJS.disableWorker = true;

//
// Get page info from document, resize canvas accordingly, and render page
//
function renderPage(task) {
  // Using promise to fetch the page
  task.pdfDoc.getPage(task.pageNum).then(function(page) {
    var viewport = page.getViewport(task.scale);
    task.canvas.height = viewport.height;
    task.canvas.width = viewport.width;

    // Render PDF page into canvas context
    var renderContext = {
      canvasContext: task.ctx,
      viewport: viewport
    };
    page.render(renderContext);
  });
}

function zoom(task, v) {
    task.pdfDoc.getPage(task.pageNum).then(function(page){
        if (v === 1) {
            task.scale = task.scale + 0.1;
            if (task.scale >= 2) {
                task.scale = 2;
            }
        }
        if (v === -1) {
            task.scale = task.scale - 0.1;
            if (task.scale <= 0) {
                task.scale = 0.1;
            }
        }
        if (v === 0) {
            task.scale = 0.8;
        }
        var viewport = page.getViewport(task.scale + 0.1);
        task.canvas.height = viewport.height;
        task.canvas.width = viewport.width;

        // Render PDF page into canvas context
        var renderContext = {
          canvasContext: task.ctx,
          viewport: viewport
        };
        page.render(renderContext);
    });

}

function enableDisabledNavButtons(task){
    if (task.pageNum === 1) {
        $("#next").removeClass("disabled");
        $("#prev").addClass("disabled");
    }
    else if (task.pageNum === task.pdfDoc.numPages) {
        $("#prev").removeClass("disabled");
        $("#next").addClass("disabled");
    }
    else {
        $("#next").removeClass("disabled");
        $("#prev").removeClass("disabled");
    }
}

function goPreviousPage(task) {
    if (task.pageNum <= 1)
        return;
    task.pageNum--;
    renderPage(task);
    $("#currentPage").text(task.pageNum);
    enableDisabledNavButtons(task);
}

function goNextPage(task) {
    if (task.pageNum >= task.pdfDoc.numPages)
        return;
    task.pageNum++;
    renderPage(task);
    $("#currentPage").text(task.pageNum);
    enableDisabledNavButtons(task);
}

function loadUserProgress() {
    pybossa.userProgress('test-1').done(function(data){
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'}); 
        $("#total").text(data.total);
        $("#done").text(data.done);
    });
}

function showPaginationOptions(task) {
    if (task.pagination) {
        $("#currentPage").text(task.pageNum);
        $("#totalPages").text(task.pdfDoc.numPages);
        $(".btn-navigate").show();
        $("#pages").show();
    }
    else {
        $(".btn-navigate").hide();
        $("#pages").hide();
    }
}

pybossa.taskLoaded(function(task, deferred){
    if ( !$.isEmptyObject(task) ) {
        if (task.state=='completed') {
            $('#answer').hide();
            $('#taskcompleted').show();
        }
        // NOTE: 
        // Modifying the URL below to another server will likely *NOT* work. Because of browser
        // security restrictions, we have to use a file server with special headers
        // (CORS) - most servers don't support cross-origin browser requests.
        // Asynchronously download PDF as an ArrayBuffer
        var canvas = $("<canvas/>", {"id": "canvas_" + task.id});
        canvas.css("border", "1px solid black");
        var viewport = $("<div/>", {"id": "viewport_" + task.id});
        viewport.css("width",  "620px");
        viewport.css("height", "755px");
        viewport.css("overflow", "auto");
        viewport.css("display", "none");
        viewport.append(canvas);
        $("#answer").append(viewport);
        
        $('#viewport_' + task.id).dragscrollable({dragSelector:'#canvas_' + task.id});
        task.canvas = document.getElementById('canvas_' + task.id);
        task.ctx = document.getElementById("canvas_" + task.id).getContext('2d');
        task.scale = 0.9;
        task.pagination = (task.info.page === undefined);
        task.pageNum = task.info.page || 1;

        PDFJS.getDocument(task.info.pdf_url).then(function getPdfHelloWorld(_pdfDoc) {
            task.pdfDoc = _pdfDoc;
            deferred.resolve(task);
        });
    }
    else {
        deferred.resolve(task);
    }

});

pybossa.presentTask(function(task, deferred){
    if ( !$.isEmptyObject(task) ) {
        loadUserProgress();
        $("textarea#text").val('');
        $("#viewport_" + task.id).show();
        showPaginationOptions(task);
        renderPage(task);
        $("#question h1").text(task.info.question);
        $("#task-id").text(task.id);
        $("#loading").hide();
        enableDisabledNavButtons(task);
        $(".btn-zoom").off('click').on('click', function(evt){
            zoom(task, parseInt($(this).attr("value")));
        });
        $(".btn-navigate").off('click').on('click', function(evt){
            if ($(this).attr("value") === "next") {
                goNextPage(task);
                return;
            }
            if ($(this).attr("value") === "prev") {
                goPreviousPage(task);
                return;
            }
        });
        $(".btn-submit").off('click').on('click', function(){
            var answer = $("textarea#text").val();
            $("#viewport_" + task.id).hide();
            pybossa.saveTask(task.id, answer).done(function(data){
                deferred.resolve();
                $("#success").fadeIn();
                setTimeout(function() { $("#success").fadeOut() }, 2000);
            })
        });
    }
    else {
        $(".skeleton").hide();
        $("#finish").fadeIn();
    }
});

pybossa.run('test-1');
})();
</script>
